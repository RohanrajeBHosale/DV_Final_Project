import pandas as pd
import plotly.express as px

# Load datasets from JSON files
dataset_files = {
    "Energy Use Per Person": "cleaned_datasets/energy_use_per_person_cleaned.json",
    "Electricity Generation": "cleaned_datasets/electricity_generation_cleaned.json",
    "Coal Consumption": "cleaned_datasets/coal_consumption_cleaned.json",
    "Renewables": "cleaned_datasets/primary_energy_consumption_from_renewables_cleaned.json",
    "Gas Consumption": "cleaned_datasets/gas_consumption_cleaned.json",
    "Carbon Intensity": "cleaned_datasets/carbon_intensity_cleaned.json",
    "Primary Energy Consumption": "cleaned_datasets/primary_energy_consumption_cleaned.json",
}

datasets = {name: pd.read_json(file) for name, file in dataset_files.items()}

# Define color scales for datasets
color_scales = {
    "Energy Use Per Person": px.colors.sequential.Viridis,
    "Electricity Generation": px.colors.sequential.Plasma,
    "Coal Consumption": px.colors.sequential.Greys,
    "Renewables": px.colors.sequential.Blues,
    "Gas Consumption": px.colors.sequential.Oranges,
    "Carbon Intensity": px.colors.sequential.Reds,
    "Primary Energy Consumption": px.colors.sequential.YlGnBu,
}

# Default metric and map view
selected_metric = "Energy Use Per Person"
map_view = "world"

# Get the dataset
dataset = datasets[selected_metric]
dataset = dataset.rename(columns={"entity": "country"})

# Select the first numerical column for visualization
metric = [col for col in dataset.columns if col not in ["country", "year", "code"]][0]

# Generate the animated choropleth map
fig = px.choropleth(
    dataset,
    locations="country",
    locationmode="country names",
    color=metric,
    hover_name="country",
    animation_frame="year",  # Enable animation by year
    title=f"{selected_metric} Over Time ({metric.replace('_', ' ').title()})",
    color_continuous_scale=color_scales[selected_metric],
)

# Adjust map region
fig.update_geos(scope=map_view, showcoastlines=True, projection_type="natural earth")

# Layout adjustments
fig.update_layout(
    margin={"r": 0, "t": 40, "l": 0, "b": 0},
    template="plotly_white",
    coloraxis_colorbar=dict(title=metric.replace("_", " ").title()),
    updatemenus=[  # Add play/pause buttons
        {
            "buttons": [
                {
                    "args": [None, {"frame": {"duration": 250, "redraw": True}, "fromcurrent": True}],
                    "label": "Play",
                    "method": "animate",
                },
                {
                    "args": [[None], {"frame": {"duration": 0, "redraw": True}, "mode": "immediate"}],
                    "label": "Pause",
                    "method": "animate",
                },
            ],
            "direction": "left",
            "pad": {"r": 10, "t": 87},
            "showactive": True,
            "type": "buttons",
            "x": 0.1,
            "xanchor": "right",
            "y": 0,
            "yanchor": "top",
        }
    ],
)

# Save the figure as an HTML file
html_file = "choropleth_dashboard.html"
fig.write_html(html_file)
print(f"Dashboard saved to {html_file}")
